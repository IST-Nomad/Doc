//Запрещает подключение новых пользователей
change logon /disable


//Powershell скрипт закрывающий активные сессии, кроме сессий администраторов из списка
$admins = "admin1", "admin2"
$sessions=quser
for ($i=1; $i -le ($sessions.length -1); $i+=1)
    {   
        $flag = 'true'
        for ($j = 0; $j -le ($admins.length -1); $j+=1)
        {           
            if ($sessions[$i].substring(0,20).trim().replace(">","") -eq $admins[$j])
                {
                    $flag = 'false'
                    break
                }
        }
        if ($flag -eq 'true')
        {           
            rwinsta $sessions[$i].substring(41,4).trim()
        }        
    }

//Разрешает подключение новых пользователей
    change logon /enable

//Отключить новые подключения
Invoke-Command -ComputerName GESTBANK -Credential $admin -ScriptBlock {change logon /disable}

//Включить новые подключения
Invoke-Command -ComputerName GESTBANK -Credential $admin -ScriptBlock {change logon /enable}



//На удаленных компьютерах, к которым вы планируете подключаться должен быть запущена служба WinRM. Проверить это можно так:
Get-Service -Name "*WinRM*" | fl

//Если служба не запущена, запустите ее:
Enable-PSRemoting

//Чтобы проверить подключение к удаленному компьютер через PowerShell Remoting используется команда:
Test-WsMan compname1

//Запрашивает данные аутентификации и записывет их в переменную $admin для дальнейшего использования
$admin = Get-Credential

//Выполняет скрипт от имени администратора
Invoke-Command -ComputerName GESTBANK -Credential $admin -ScriptBlock {Get-NetAdapter}

//Удаленное исполнение скрипта который находится локально
Invoke-Command -ComputerName Gestbank -FilePath C:\Scripts\no_rdp.ps1

//Выполнение команды на нескольких ПК 
Invoke-Command server1, server2, server3 -ScriptBlock {get-date}

//Список компьютеров можно поместить в переменную (массив):
$servers = @(″server1″,″server2″,″server3″)
Invoke-Command -ScriptBlock { get-date} -ComputerName $servers

//Или получить из текстового файла:
Invoke-Command -ScriptBlock {Restart-Service spooler} -ComputerName(Get-Content c:\ps\servers.txt)

//Чтобы выполнить команду на всех Windows Server в домене, исопльзуйте такой код:
$computers = (Get-ADComputer -Filter 'operatingsystem -like "*Windows server*" -and enabled -eq "true"').Name
Invoke-Command -ComputerName $computers -ScriptBlock {get-date} -ErrorAction SilentlyContinue

//Чтобы понять с какого компьютера получены результаты, нужно использовать специальную переменную окружения PSComputerName.
$results = Invoke-Command server1, server2, server3 -ScriptBlock {get-date}
$results | Select-Object PSComputerName, DateTime